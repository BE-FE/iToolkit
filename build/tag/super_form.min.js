riot.tag("super-form",'<form onsubmit="{ submit }" > <yield> </form>',function(e){function n(e,n,a,t,i,s){var r=isNaN(e),l=isNaN(n),u=t.length;r||l?(r||(e>u?(i.push(s),o.onValidRefuse(a,o.minWarning(e))):o.onValidPass(a,o.successTips)),l||(u>n?(i.push(s),o.onValidRefuse(a,o.maxWarning(n))):o.onValidPass(a,o.successTips)),l&&r&&o.onValidPass(a,o.successTips)):u>n||e>u?(i.push(s),o.onValidRefuse(a,o.bpWarning(e,n))):o.onValidPass(a,o.successTips)}function a(e,n,a,t,i,s){var r=isNaN(e),l=isNaN(n),t=+t;r||l?(r||(e>t?(i.push(s),o.onValidRefuse(a,o.minNumWarning(e))):o.onValidPass(a,o.successTips)),l||(t>n?(i.push(s),o.onValidRefuse(a,o.maxNumWarning(n))):o.onValidPass(a,o.successTips)),l&&r&&o.onValidPass(a,o.successTips)):t>n||e>t?(i.push(s),o.onValidRefuse(a,o.numBpWarning(e,n))):o.onValidPass(a,o.successTips)}function t(e){l([],this)}function s(e){return toString.call(e).match(/\ (.*)\]/)[1]}function r(e){var n=s(e);return"Null"===n||"Undefined"===n||"Function"===n?e:new window[n](e)}function l(e,n){var n=n,a=n.getAttribute("valid"),t=n.getAttribute("customValid"),i=n.getAttribute("vr"),s=n.getAttribute("orient"),r=parseInt(n.getAttribute("max"),10),l=parseInt(n.getAttribute("min"),10),d=n.type,c=n.getAttribute("allowEmpty"),f=n.value,g=n.name,v=n;if(null!==c||!isNaN(r)||!isNaN(l)||null!==a||null!==t||null!==i||null!==s){if(c&&(""===f||"string"!=typeof f))return void o.onValidPass(v,o.successTips);if(g&&a){if("email"===a)f.match(/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/)?o.onValidPass(v,o.successTips):(e.push(g),o.onValidRefuse(v,o.emailWarning));else if("mobile"===a)f.match(/^1[3|4|5|8][0-9]\d{4,8}$/)?o.onValidPass(v,o.successTips):(e.push(g),o.onValidRefuse(v,o.mobileWarning));else if("url"===a)f.match(/((http|ftp|https|file):\/\/([\w\-]+\.)+[\w\-]+(\/[\w\u4e00-\u9fa5\-\.\/?\@\%\!\&=\+\~\:\#\;\,]*)?)/)?o.onValidPass(v,o.successTips):(e.push(g),o.onValidRefuse(v,o.urlWarning));else if("present"===a)f=f.replace(" ",""),f.length?p("string").handler(l,r,v,f,e,g):(e.push(g),o.onValidRefuse(v,o.presentWarning));else if(a.match(/^\/\S+\/$/)){a=a.replace(/^\//,""),a=a.replace(/\/$/,"");var h=new RegExp(a);h.test(f)?p("string").handler(l,r,v,f,e,g):(e.push(g),o.onValidRefuse(v,o.regWarning))}else if(m[a.toUpperCase()]){var h=m[a.toUpperCase()];h.test(f)?p("number").handler(l,r,v,f,e,g):(e.push(g),o.onValidRefuse(v,o.numWarning))}}else if(g&&!a)if(t){if(window[t]){var h=window[t].regExp,T=window[t].message||o.regWarning;h&&h.test(f)?p("string").handler(l,r,v,f,e,g):(e.push(g),o.onValidRefuse(v,T))}}else"text"===d&&p("string").handler(l,r,v,f,e,g);if(s){var b=u.querySelector(s);if(n===b||!b)return;n=b,i=n.getAttribute("vr")}if(!e.length&&i){var N=i.split("::"),C=N[0],V=N[1]?N[1].split(","):void 0,E=!1;try{iToolkit[C]&&(E=iToolkit[C].apply(n,V))}catch(y){throw E=!1,y}E||e.push("fail")}}}var o=this,u=o.root,d=o.opts.opts||o.opts,c=["insertTip","ajaxSubmit","submit","removeTips","insertTip","removeTip","loadData","getData","setData"],m={NON_NEGATIVE_INT:/^0$|^-[1-9]\d*$/,POSITIVE_INT:/^[1-9]\d*$/,NON_POSITIVE_INT:/^[1-9]\d*$|^0$/,NEGATIVE_INT:/^-[1-9]\d*$/,INT:/^-?[1-9]\d*$|^0$/,NON_NEGATIVE_FLOAT:/^(\d)(\.\d+)?$|^([1-9]\d*)(\.\d+)?$|^0$/,POSITIVE_FLOAT:/^(\d)(\.\d+)?$|^([1-9]\d*)(\.\d+)?$/,NON_POSITIVE_FLOAT:/^(-\d)(\.\d+)?$|^(-[1-9]\d*)(\.\d+)?$|^0$/,NEGATIVE_FLOAT:/^(-\d)(\.\d+)?$|^(-[1-9]\d*)(\.\d+)?$/,FLOAT:/^(-?\d)(\.\d+)?$|^(-?[1-9]\d*)(\.\d+)?$|^0$/};o.presentWarning="必填",o.emailWarning="邮箱格式错误",o.mobileWarning="手机格式错误",o.urlWarning="网址格式错误",o.successTips="通过",o.regWarning="字段不符合验证规则",o.numWarning="数字格式错误",o.passClass=d.passClass||"valid-pass",o.failedClass=d.failedClass||"valid-failed";var p=function(e){return{handler:function(t,i,s,r,l,o){switch(e){case"number":return a(t,i,s,r,l,o);case"string":default:return n(t,i,s,r,l,o)}}}};o.one("mount",function(){if(u.style.display="block",d.realTime&&d.valid)for(var e=o.root.getElementsByTagName("form")[0].elements,n=0,a=e.length;a>n;n++){var i=e[n].type;("submit"!==i||"button"!==i)&&(e[n].addEventListener("input",t,!1),("checkbox"===i||"radio"===i)&&e[n].addEventListener("change",t,!1),e[n].addEventListener("input",t,!1))}}),u.loadData=function(e,n){if(utils.isObject(e))for(var a in e)e[a]=r(e[a]);else e=r(e);n=n||"data",o[n]=e,o.update()},u.setData=function(e,n){o.data[n]=r(e),o.update()},o.checkExistKey=function(e,n,a){if(e.hasOwnProperty(n))if(utils.isArray(e[n]))e[n].push(a);else{var t=[];t.push(e[n]),t.push(a),e[n]=t}else e[n]=a},o.getData=u.getData=function(){for(var e=o.root.getElementsByTagName("form")[0].elements,n={},a=0;a<e.length;a++)if(e[a].name)if("SELECT"===e[a].tagName){var t=e[a].selectedOptions;for(j=0;j<t.length;j++)value=t[j].value,o.checkExistKey(n,e[a].name,encodeURIComponent(value))}else"checkbox"===e[a].type||"radio"===e[a].type?e[a].checked&&(value=e[a].value,o.checkExistKey(n,e[a].name,encodeURIComponent(value))):(value=e[a].value,o.checkExistKey(n,e[a].name,encodeURIComponent(value)));return n};for(i in d)c.indexOf(i)<0&&(o[i]=d[i]);o.data=d.data,o.submitingText=d.submitingText||"提交中...",void 0===d.valid&&(d.valid=!0),o.maxWarning=d.maxWarning||function(e){return"不得超过"+e+"个字符"},o.minWarning=d.minWarning||function(e){return"不得小于"+e+"个字符"},o.bpWarning=d.bpWarning||function(e,n){return"只允许"+e+"-"+n+"个字符"},o.minNumWarning=d.minNumWarning||function(e){return"不得小于"+e},o.maxNumWarning=d.maxNumWarning||function(e){return"不得大于"+e},o.numBpWarning=d.numBpWarning||function(e,n){return"输入数字应在"+e+"-"+n+"之间"},o.removeTips=u.removeTips=function(){function e(){for(i=0;i<t.length;i++)t[i].parentNode.removeChild(t[i]),t.length&&e()}var n=o.root,a=n.getElementsByTagName("form")[0].elements,t=n.getElementsByClassName("tip-container");t&&t.length&&e();for(var i=0;i<a.length;i++)utils.removeClass(a[i],o.passClass),utils.removeClass(a[i],o.failedClass)},o.removeTip=u.removeTip=function(e){var n=e.nextElementSibling;n&&n.className.match(/tip-container/)&&e.parentNode.removeChild(n),utils.removeClass(e,o.passClass),utils.removeClass(e,o.failedClass)},o.insertTip=u.insertTip=function(e,n,a){var t=e.nextElementSibling;t&&t.className.match(/tip-container/)&&e.parentNode.removeChild(t);var i=document.createElement("span");i.className=a,i.innerHTML=n,utils.insertAfterText(i,e)},o.onValidRefuse=u.onValidRefuse=d.onValidRefuse||function(e,n){o.insertTip(e,n,"tip-container"),utils.removeClass(e,o.passClass),utils.addClass(e,o.failedClass)},o.onValidPass=u.onValidPass=d.onValidPass||function(e,n){o.insertTip(e,n,"tip-container success"),utils.removeClass(e,o.failedClass),utils.addClass(e,o.passClass)},o.ajaxSubmit=function(e,n){for(var a="",t=0;t<e.length;t++){if(e[t].name)if("SELECT"===e[t].tagName){var i=e[t].selectedOptions;for(j=0;j<i.length;j++)value=i[j].value,a+=e[t].name+"="+encodeURIComponent(value)+"&"}else"checkbox"===e[t].type||"radio"===e[t].type?e[t].checked&&(value=e[t].value,a+=e[t].name+"="+encodeURIComponent(value)+"&"):(value=e[t].value,a+=e[t].name+"="+encodeURIComponent(value)+"&");if("submit"===e[t].type)if("BUTTON"===e[t].tagName){var s=e[t],r=s.innerHTML;s.disabled="disabled",s.innerHTML=o.submitingText}else{var s=e[t],r=s.value;s.disabled="disabled",s.value=o.submitingText}}var l=new XMLHttpRequest;l.open("POST",n,!0),l.setRequestHeader("Content-type","application/x-www-form-urlencoded"),l.send(a),l.onreadystatechange=function(){if(4===l.readyState)if(o.removeTips(),"BUTTON"===s.tagName?s.innerHTML=r:s.value=r,s.disabled=!1,d.complete&&"function"==typeof d.complete&&d.complete(),200===l.status)try{var e=JSON.parse(l.responseText);d.callback&&d.callback(e),EC.trigger("submit_success",e)}catch(n){throw new Error(n.message)}else d.errCallback&&d.errCallback(a),EC.trigger("submit_error",a)}},this.submit=function(e){var n=[],a=o.root.getElementsByTagName("form")[0].elements,t=o.action||o.root.getAttribute("action"),i=t;if(d.valid)for(var s=0;s<a.length;s++)l(n,a[s]);if(!n.length)try{d.beforeSubmit&&d.beforeSubmit(n)}catch(e){n.push(e)}return n.length?!1:d.normalSubmit?(o.root.firstChild.setAttribute("action",t),!0):(e.preventDefault(),void o.ajaxSubmit(a,i))}.bind(this)});